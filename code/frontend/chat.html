<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Chat - Telemedicine Portal</title>
  <style>
    :root {
      --bg: #fefefe;
      --text: #1c1c1e;
      --subtext: #555;
      --primary: #007aff;
      --card: #ffffff;
      --input-bg: #f7f7f8;
      --input-border: #ccc;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--card);
      padding: 1.5rem 1rem;
      text-align: center;
      border-bottom: 1px solid #ddd;
      animation: fadeIn 1s ease-out;
    }

    nav ul {
      list-style: none;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 0;
      margin-top: 1rem;
    }

    nav ul li a {
      text-decoration: none;
      color: var(--primary);
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      transition: background-color 0.3s ease;
    }

    nav ul li a:hover {
      background-color: rgba(0, 122, 255, 0.1);
    }

    .container {
      display: flex;
      flex-grow: 1;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      gap: 2rem;
    }

    .doctors-sidebar {
      width: 300px;
      background-color: var(--card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: fit-content;
    }

    .doctors-sidebar h2 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      text-align: center;
    }

    .search-container {
      margin-bottom: 1.5rem;
      position: relative;
    }

    #search-doctors {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 25px;
      outline: none;
      transition: border-color 0.3s ease;
      padding-right: 2.5rem;
    }

    #search-doctors:focus {
      border-color: var(--primary);
    }

    .search-icon {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--subtext);
    }

    .doctors-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .doctor-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .doctor-item:hover {
      background-color: var(--input-bg);
    }

    .doctor-item.active {
      background-color: rgba(0, 122, 255, 0.1);
      border-left: 3px solid var(--primary);
    }

    .doctor-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 1rem;
      flex-shrink: 0;
    }

    .doctor-info {
      flex-grow: 1;
    }

    .doctor-info h3 {
      margin: 0;
      font-size: 1rem;
    }

    .doctor-info p {
      margin: 0.2rem 0 0;
      font-size: 0.8rem;
      color: var(--subtext);
    }

    .chat-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    .chat-header {
      padding: 1.5rem;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
    }

    .chat-header .doctor-avatar {
      margin-right: 1rem;
      background-color: white;
      color: var(--primary);
    }

    .chat-header-info h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .chat-header-info p {
      margin: 0.2rem 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .no-doctor-selected {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 2rem;
      text-align: center;
      color: var(--subtext);
    }

    .no-doctor-selected svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    #chat-window {
      display: flex;
      flex-direction: column;
      height: 500px;
      padding: 1rem;
      background-color: var(--input-bg);
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: var(--card);
      border-radius: 12px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }

    .message {
      max-width: 70%;
      padding: 0.8rem 1rem;
      margin-bottom: 0.8rem;
      border-radius: 15px;
      word-wrap: break-word;
    }

    .message.user {
      background-color: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }

    .message.doctor {
      background-color: var(--card);
      color: var(--text);
      margin-right: auto;
      border-bottom-left-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.3rem;
      text-align: right;
    }

    .chat-input-container {
      display: flex;
      padding: 0.5rem;
      background-color: var(--card);
      border-top: 1px solid var(--input-border);
    }

    #chat-input {
      flex-grow: 1;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 25px;
      outline: none;
      margin-right: 0.5rem;
    }

    #chat-input:focus {
      border-color: var(--primary);
    }

    #send-message {
      padding: 0 1.5rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #send-message:hover {
      background-color: #005fcc;
    }

    footer {
      padding: 1.5rem;
      text-align: center;
      color: #999;
      border-top: 1px solid #eee;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .doctors-sidebar {
        width: 100%;
      }

      .chat-container {
        height: 500px;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="appointments.html">Book Appointment</a></li>
        <li><a href="bookings.html">My Bookings</a></li>
        <li><a href="ai-chat.html">AI Chat</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <div class="doctors-sidebar">
      <h2>My Doctors</h2>
      <div class="search-container">
        <input type="text" id="search-doctors" placeholder="Search doctors...">
        <span class="search-icon">üîç</span>
      </div>
      <div class="doctors-list" id="doctors-list">
        <!-- Doctors will be loaded here -->
      </div>
    </div>

    <div class="chat-container" id="chat-container">
      <div id="no-doctor-selected" class="no-doctor-selected">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3>Select a doctor to start chatting</h3>
        <p>Choose a doctor from your list to view your conversation history and send new messages</p>
      </div>

      <div id="chat-interface" style="display: none;">
        <div class="chat-header">
          <div class="doctor-avatar" id="current-doctor-avatar">JD</div>
          <div class="chat-header-info">
            <h2 id="current-doctor-name">Dr. John Doe</h2>
            <p id="current-doctor-specialty">Cardiologist</p>
          </div>
        </div>
        <div id="chat-window">
          <div id="messages"></div>
          <div class="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type your message...">
            <button id="send-message">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Telemedicine Portal</p>
  </footer>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Elementi DOM
    const searchInput = document.getElementById('search-doctors');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-message');
    const messagesContainer = document.getElementById('messages');
    let currentDoctor = null;
    let currentUser = null;
    let pollingInterval = null;
    
    // Verifica autenticazione
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }
    
    // Carica dati utente corrente
    async function loadCurrentUser() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5501/user-data', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('Failed to load user data');
        const userData = await response.json();
        currentUser = userData;
        return userData;
      } catch (error) {
        console.error('Error loading user data:', error);
        window.location.href = 'login.html';
      }
    }
    
    // Carica lista dottori
    async function loadDoctors() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5501/doctors', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
      } catch (error) {
        console.error('Error loading doctors:', error);
        return [];
      }
    }
    
    // Carica messaggi conversazione
    async function loadDoctorMessages(doctorId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5501/messages/conversation/${doctorId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!response.ok) throw new Error('Failed to load messages');
        const messages = await response.json();
        return messages.map(msg => ({
          id: msg.id,
          sender_id: msg.sender_id,
          text: msg.content,
          timestamp: msg.timestamp,
          sender: msg.sender_type === currentUser.user_type ? 'user' : 'doctor'
        }));
      } catch (error) {
        console.error('Error loading messages:', error);
        return [];
      }
    }
    
    // Invia messaggio
    async function sendMessageToServer(content, receiverId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5501/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            receiver_id: receiverId,
            content: content
          })
        });
        
        if (!response.ok) throw new Error('Failed to send message');
        const result = await response.json();
        return {
          id: result.id,
          sender_id: result.sender_id,
          text: result.content,
          timestamp: result.timestamp,
          sender: 'user'
        };
      } catch (error) {
        console.error('Error sending message:', error);
        return null;
      }
    }
    
    // Aggiorna conteggio messaggi non letti
    async function updateUnreadCount() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5501/messages/unread-count', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const unreadCount = data.unread_count;
          const chatLink = document.querySelector('a[href="chat.html"]');
          
          if (unreadCount > 0) {
            let badge = chatLink.querySelector('.unread-badge');
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'unread-badge';
              badge.style.cssText = `
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: red;
                color: white;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                font-size: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
              `;
              chatLink.style.position = 'relative';
              chatLink.appendChild(badge);
            }
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
          } else {
            const badge = chatLink.querySelector('.unread-badge');
            if (badge) badge.remove();
          }
        }
      } catch (error) {
        console.error('Error updating unread count:', error);
      }
    }
    
    // Render lista dottori
    function renderDoctorsList(doctors) {
      const doctorsList = document.getElementById('doctors-list');
      doctorsList.innerHTML = '';

      if (doctors.length === 0) {
        doctorsList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--subtext);">No doctors found</div>';
        return;
      }

      doctors.forEach(doctor => {
        const doctorItem = document.createElement('div');
        doctorItem.className = 'doctor-item';
        if (currentDoctor && currentDoctor.id === doctor.id) {
          doctorItem.classList.add('active');
        }

        const initials = (doctor.nome ? doctor.nome[0] : '') + (doctor.cognome ? doctor.cognome[0] : '');
        
        doctorItem.innerHTML = `
          <div class="doctor-avatar">${initials}</div>
          <div class="doctor-info">
            <h3>Dr. ${doctor.nome} ${doctor.cognome}</h3>
            <p>${doctor.specialization || 'General Practitioner'}</p>
          </div>
        `;

        if (doctor.unreadCount > 0) {
          const unreadBadge = document.createElement('div');
          unreadBadge.className = 'doctor-unread';
          unreadBadge.title = `${doctor.unreadCount} unread messages`;
          doctorItem.appendChild(unreadBadge);
        }

        doctorItem.addEventListener('click', async function() {
          await selectDoctor(doctor);
        });

        doctorsList.appendChild(doctorItem);
      });
    }

    // Seleziona dottore e carica messaggi
    async function selectDoctor(doctor) {
      currentDoctor = doctor;
      
      document.getElementById('no-doctor-selected').style.display = 'none';
      document.getElementById('chat-interface').style.display = 'block';
      
      const initials = (doctor.nome ? doctor.nome[0] : '') + (doctor.cognome ? doctor.cognome[0] : '');
      document.getElementById('current-doctor-avatar').textContent = initials;
      document.getElementById('current-doctor-name').textContent = `Dr. ${doctor.nome} ${doctor.cognome}`;
      document.getElementById('current-doctor-specialty').textContent = doctor.specialization || 'General Practitioner';
      
      const messages = await loadDoctorMessages(doctor.id);
      renderMessages(messages);
      
      const doctorItems = document.querySelectorAll('.doctor-item');
      doctorItems.forEach(item => {
        item.classList.remove('active');
      });
      
      const clickedItem = Array.from(doctorItems).find(item => 
        item.querySelector('.doctor-info h3').textContent === `Dr. ${doctor.nome} ${doctor.cognome}`
      );
      if (clickedItem) {
        clickedItem.classList.add('active');
      }
      
      // Avvia polling per nuovi messaggi
      startPolling(doctor.id);
      updateUnreadCount();
    }

    // Render messaggi
    function renderMessages(messages) {
      messagesContainer.innerHTML = '';
      
      if (messages.length === 0) {
        messagesContainer.innerHTML = `
          <div style="text-align: center; color: var(--subtext); padding: 2rem;">
            No messages yet. Start your conversation with Dr. ${currentDoctor.nome}
          </div>
        `;
        return;
      }
      
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        const isCurrentUser = msg.sender === 'user' || msg.sender_id === currentUser.id;
        messageDiv.className = `message ${isCurrentUser ? 'user' : 'doctor'}`;
        
        const timestamp = new Date(msg.timestamp);
        const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.innerHTML = `
          ${msg.text}
          <div class="message-time">${timeString}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
      });
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Invia messaggio
    async function sendMessage() {
      const messageText = chatInput.value.trim();
      if (messageText === '' || !currentDoctor || !currentUser) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user';
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        ${messageText}
        <div class="message-time">${timeString}</div>
      `;
      messagesContainer.appendChild(messageDiv);
      
      chatInput.value = '';
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      const response = await sendMessageToServer(messageText, currentDoctor.id);
      
      if (!response) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message error';
        errorDiv.innerHTML = `
          Failed to send message. Please try again.
          <div class="message-time">${timeString}</div>
        `;
        messagesContainer.appendChild(errorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }
    
    // Polling per nuovi messaggi
    function startPolling(doctorId) {
      if (pollingInterval) clearInterval(pollingInterval);
      
      pollingInterval = setInterval(async () => {
        if (!currentDoctor || currentDoctor.id !== doctorId) return;
        
        const messages = await loadDoctorMessages(doctorId);
        renderMessages(messages);
        updateUnreadCount();
      }, 5000);
    }
    
    // Ricerca dottori
    searchInput.addEventListener('input', async function() {
      const searchTerm = this.value.toLowerCase();
      const doctors = await loadDoctors();
      const filteredDoctors = doctors.filter(doctor => 
        `${doctor.nome} ${doctor.cognome}`.toLowerCase().includes(searchTerm) || 
        (doctor.specialization && doctor.specialization.toLowerCase().includes(searchTerm))
      );
      renderDoctorsList(filteredDoctors);
    });
    
    // Gestione invio messaggi
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Inizializzazione
    async function initialize() {
      if (!checkAuth()) return;
      
      await loadCurrentUser();
      const doctors = await loadDoctors();
      await updateUnreadCount();
      
      try {
        const token = localStorage.getItem('token');
        const conversationsResponse = await fetch('http://localhost:5501/messages/conversations', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (conversationsResponse.ok) {
          const conversations = await conversationsResponse.json();
          
          const doctorsWithConversations = doctors.map(doctor => {
            const conversation = conversations.find(c => c.other_user_id === doctor.id);
            return {
              ...doctor,
              hasConversation: !!conversation,
              lastMessageTime: conversation?.last_message_time,
              unreadCount: conversation?.unread_count || 0
            };
          });
          
          renderDoctorsList(doctorsWithConversations);
          
          // Se c'√® una conversazione recente, seleziona automaticamente quel dottore
          if (conversations.length > 0) {
            const mostRecent = conversations[0];
            const doctor = doctors.find(d => d.id === mostRecent.other_user_id);
            if (doctor) {
              await selectDoctor({
                ...doctor,
                unreadCount: mostRecent.unread_count
              });
            }
          }
        } else {
          renderDoctorsList(doctors);
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
        renderDoctorsList(doctors);
      }
      
      // Aggiorna periodicamente il conteggio dei messaggi non letti
      setInterval(updateUnreadCount, 30000);
    }
    
    initialize();
  });
</script>
</body>
</html>
